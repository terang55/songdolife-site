name: ë§¤ì¼ ë¶€ë™ì‚° ë°ì´í„° ìë™ ìˆ˜ì§‘

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 6ì‹œ (KST) = UTC 21:00 (ì „ë‚ )
    - cron: '0 21 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  collect-realestate-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm install
    
    - name: ë¶€ë™ì‚° ë°ì´í„° ìˆ˜ì§‘
      run: |
        cd frontend
        node scripts/collect-daily-realestate.js
    
    - name: Git ì„¤ì •
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions Bot"
    
    - name: ë³€ê²½ì‚¬í•­ í™•ì¸ ë° ì»¤ë°‹
      run: |
        # ìƒˆë¡œ ìƒì„±ëœ ë°ì´í„° íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
        if git diff --quiet HEAD -- frontend/public/data/realestate_*.json; then
          echo "ìƒˆë¡œìš´ ë°ì´í„° ì—†ìŒ - ì»¤ë°‹ ê±´ë„ˆëœ€"
        else
          echo "ìƒˆë¡œìš´ ë¶€ë™ì‚° ë°ì´í„° ë°œê²¬"
          TODAY=$(date +%Y-%m-%d)
          git add frontend/public/data/realestate_${TODAY}.json
          git commit -m "ğŸ  ìë™ ë¶€ë™ì‚° ë°ì´í„° ì—…ë°ì´íŠ¸: ${TODAY}" || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          git push origin main || echo "í‘¸ì‹œ ì‹¤íŒ¨"
          echo "âœ… ë¶€ë™ì‚° ë°ì´í„° ìë™ ìˆ˜ì§‘ ë° ì»¤ë°‹ ì™„ë£Œ"
        fi
    
    - name: ìˆ˜ì§‘ ê²°ê³¼ ìš”ì•½
      run: |
        TODAY=$(date +%Y-%m-%d)
        if [ -f "frontend/public/data/realestate_${TODAY}.json" ]; then
          echo "ğŸ“Š ìˆ˜ì§‘ëœ ë°ì´í„° íŒŒì¼: realestate_${TODAY}.json"
          echo "ğŸ“ˆ íŒŒì¼ í¬ê¸°: $(du -h frontend/public/data/realestate_${TODAY}.json | cut -f1)"
          echo "ğŸ  ê±°ë˜ ê±´ìˆ˜: $(cat frontend/public/data/realestate_${TODAY}.json | jq '.total_count // 0')"
        else
          echo "âŒ ë°ì´í„° íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          exit 1
        fi